"use strict";var publicKey="BG52pXH36Y_1O5MZ-uw2X5cDLSsH_Hs-LcunomzGbhm3OlZBtSmOtXUYHrtm349y4e5TXJhuMgyD69V1ovmjDdw",debug=!1,installPrompt,DBNAME_PREFIX,DATA,MESSAGING;navigator.serviceWorker&&navigator.serviceWorker.register("/sw.js").then(function(n){debug&&console.log("Service worker registered with scope: ",n.scope)},function(){debug&&console.log("Failed to register service worker")});window.addEventListener("load",function(){function n(){var n=document.querySelector(".conn-status"),t=typeof navigator.onLine=="undefined"||navigator.onLine,i=t?"online":"offline";n.classList.remove(t?"offline":"online");n.classList.add(i);n.innerHTML=i;navigator.onLine?$("nav.navbar li").not(".available-offline").removeClass("offline"):$("nav.navbar li").not(".available-offline").addClass("offline")}window.addEventListener("online",n);window.addEventListener("offline",n);n()}),function(){function v(n){return Array.prototype.slice.call(n)}function c(n){return new Promise(function(t,i){n.onsuccess=function(){t(n.result)};n.onerror=function(){i(n.error)}})}function f(n,t,i){var r,u=new Promise(function(u,f){r=n[t].apply(n,i);c(r).then(u,f)});return u.request=r,u}function y(n,t,i){var u=f(n,t,i);return u.then(function(n){if(n)return new r(n,u.request)})}function i(n,t,i){i.forEach(function(i){Object.defineProperty(n.prototype,i,{get:function(){return this[t][i]},set:function(n){this[t][i]=n}})})}function h(n,t,i,r){r.forEach(function(r){r in i.prototype&&(n.prototype[r]=function(){return f(this[t],r,arguments)})})}function e(n,t,i,r){r.forEach(function(r){r in i.prototype&&(n.prototype[r]=function(){return this[t][r].apply(this[t],arguments)})})}function l(n,t,i,r){r.forEach(function(r){r in i.prototype&&(n.prototype[r]=function(){return y(this[t],r,arguments)})})}function t(n){this._index=n}function r(n,t){this._cursor=n;this._request=t}function n(n){this._store=n}function u(n){this._tx=n;this.complete=new Promise(function(t,i){n.oncomplete=function(){t()};n.onerror=function(){i(n.error)};n.onabort=function(){i(n.error)}})}function o(n,t,i){this._db=n;this.oldVersion=t;this.transaction=new u(i)}function s(n){this._db=n}i(t,"_index",["name","keyPath","multiEntry","unique"]);h(t,"_index",IDBIndex,["get","getKey","getAll","getAllKeys","count"]);l(t,"_index",IDBIndex,["openCursor","openKeyCursor"]);i(r,"_cursor",["direction","key","primaryKey","value"]);h(r,"_cursor",IDBCursor,["update","delete"]);["advance","continue","continuePrimaryKey"].forEach(function(n){n in IDBCursor.prototype&&(r.prototype[n]=function(){var t=this,i=arguments;return Promise.resolve().then(function(){return t._cursor[n].apply(t._cursor,i),c(t._request).then(function(n){if(n)return new r(n,t._request)})})})});n.prototype.createIndex=function(){return new t(this._store.createIndex.apply(this._store,arguments))};n.prototype.index=function(){return new t(this._store.index.apply(this._store,arguments))};i(n,"_store",["name","keyPath","indexNames","autoIncrement"]);h(n,"_store",IDBObjectStore,["put","add","delete","clear","get","getAll","getKey","getAllKeys","count"]);l(n,"_store",IDBObjectStore,["openCursor","openKeyCursor"]);e(n,"_store",IDBObjectStore,["deleteIndex"]);u.prototype.objectStore=function(){return new n(this._tx.objectStore.apply(this._tx,arguments))};i(u,"_tx",["objectStoreNames","mode"]);e(u,"_tx",IDBTransaction,["abort"]);o.prototype.createObjectStore=function(){return new n(this._db.createObjectStore.apply(this._db,arguments))};i(o,"_db",["name","version","objectStoreNames"]);e(o,"_db",IDBDatabase,["deleteObjectStore","close"]);s.prototype.transaction=function(){return new u(this._db.transaction.apply(this._db,arguments))};i(s,"_db",["name","version","objectStoreNames"]);e(s,"_db",IDBDatabase,["close"]);["openCursor","openKeyCursor"].forEach(function(i){[n,t].forEach(function(n){i in n.prototype&&(n.prototype[i.replace("open","iterate")]=function(){var n=v(arguments),u=n[n.length-1],t=this._store||this._index,r=t[i].apply(t,n.slice(0,-1));r.onsuccess=function(){u(r.result)}})})});[t,n].forEach(function(n){n.prototype.getAll||(n.prototype.getAll=function(n,t){var r=this,i=[];return new Promise(function(u){r.iterateCursor(n,function(n){if(!n){u(i);return}if(i.push(n.value),t!==undefined&&i.length==t){u(i);return}n.continue()})})})});var a={open:function(n,t,i){var u=f(indexedDB,"open",[n,t]),r=u.request;return r&&(r.onupgradeneeded=function(n){i&&i(new o(r.result,n.oldVersion,r.transaction))}),u.then(function(n){return new s(n)})},"delete":function(n){return f(indexedDB,"deleteDatabase",[n])}};typeof module!="undefined"?(module.exports=a,module.exports.default=module.exports):self.idb=a}();DBNAME_PREFIX="topup.co.zw";DATA={dbUserToken:null,dbPromise:null,dbVersion:10,requiredStores:[{storename:"vouchers",keypath:"id",indexes:["used","purchased"]},{storename:"history",keypath:"guid",indexes:["date"]},{storename:"accounts",keypath:"guid",indexes:["name","purchased"]},{storename:"contacts",keypath:"guid",indexes:["name"]},{storename:"paymentmethods",keypath:"guid",indexes:["name"]},{storename:"settings",keypath:"key",indexes:["key"]},{storename:"pending",keypath:"id",autoIncrement:!0}],GetUserToken:function(){var t=document.cookie.match(/(?:^|;+|\s+)uat=([^;]*)/),n=(t||["",""])[1].match(/^([a-f0-9]{8})-(([a-f0-9]{4})-){3}([a-f0-9]{12})$/);return n?n[4]:null},DbOpenForCurrentUser:function(){if(DATA.dbPromise){var n=DATA.GetUserToken();if(n===DATA.dbUserToken)return!0;debug&&console.log("Database is not open for user "+n)}else debug&&console.log("Database is not open.");return!1},Init:function(){return new Promise(function(n,t){if(DATA.DbOpenForCurrentUser()){n();return}if("indexedDB"in window){var i=DATA.GetUserToken();if(!i){t("No user access token found. Database will remain closed");return}DATA.dbPromise=idb.open(DBNAME_PREFIX+"-"+i,DATA.dbVersion,function(n){if(debug&&console.log("Database upgrade in progress..."),n.oldVersion!=0&&n.oldVersion<10){n.deleteObjectStore("vouchers");var t=n.transaction,i=t.objectStore("settings");i.delete("all-lastsync");DATA.getJson("/userapi/sync?since=0").then(n=>{var t=n.data;DATA.SyncDown(t.vouchers,"vouchers","id").then(function(){window.VouchersSyncd=!0;typeof VOUCHERS!="undefined"&&VOUCHERS.AfterSync&&VOUCHERS.AfterSync()})})}$.each(DATA.requiredStores,function(){var i,r,t;if(n.objectStoreNames.contains(this.storename)?(i=n.transaction.objectStore(this.storename),debug&&console.log(this.storename,"already exists")):(debug&&console.log("Creating ",this.storename),i=n.createObjectStore(this.storename,{keyPath:this.keypath,autoIncrement:this.autoIncrement})),this.indexes)for(r in this.indexes)t=this.indexes[r],i.indexNames.contains(t)?debug&&console.log(t,"already exists on",this.storename):(debug&&console.log("Creating",t,"on",this.storename),i.createIndex(t,t,{unique:!1}))})});DATA.dbUserToken=i;DATA.dbPromise.then(function(){n();DATA.SyncAll()}).catch(function(){DATA.dbUserToken=null;t()})}else debug&&console.log("This browser doesn't support IndexedDB"),t()})},SyncAll:function(){return new Promise(function(n){DATA.SyncUp().then(function(){DATA.GetSetting("all-lastsync",0).then(n=>{DATA.getJson("/userapi/sync?since="+n).then(n=>{var t=n.data;DATA.SyncDown(t.vouchers,"vouchers","id").then(function(){window.VouchersSyncd=!0;typeof VOUCHERS!="undefined"&&VOUCHERS.AfterSync&&VOUCHERS.AfterSync()});DATA.SyncDown(t.paymentmethods,"paymentmethods","id").then(function(){window.PaymethodsSyncd=!0;typeof PAYMETHODS!="undefined"&&PAYMETHODS.AfterSync&&PAYMETHODS.AfterSync()});DATA.SyncDown(t.contacts,"contacts","guid").then(function(){window.ContactsSyncd=!0;typeof CONTACTS!="undefined"&&CONTACTS.AfterSync&&CONTACTS.AfterSync()});DATA.SyncDown(t.history,"history","guid").then(function(){window.HistorySyncd=!0;typeof HISTORY!="undefined"&&HISTORY.AfterSync&&HISTORY.AfterSync()});DATA.SyncDown(t.accounts,"accounts","guid").then(function(){window.AccountsSyncd=!0;typeof ACCOUNTS!="undefined"&&ACCOUNTS.AfterSync&&ACCOUNTS.AfterSync()})})}).then(function(){DATA.SetSetting("all-lastsync",(new Date).getTime())})}).catch(()=>{n()})})},SyncUp:function(){return MESSAGING.ShowSyncProgress("Synchronizing changes"),DATA.GetObjects("pending").then(n=>{var t=n.objects;for(var i in t)DATA.postJson(t[i].url,t[i].json).then(function(){DATA.DeleteObject("pending",t[i].id)}).catch(function(){})}).then(()=>{MESSAGING.HideSyncProgress()})},SyncDown:function(n,t,i){return new Promise(r=>{DATA.GetObjects(t).then(r=>{var f,u,e;if(n&&n.length>0)for(f=r.objects,u=f.length-1;u>=0;u--)e=n.find(function(n){return n[i]==f[u][i]}),e&&e.deleted&&DATA.DeleteObject(t,f[u][i])}).then(()=>{for(var i=n.length-1;i>=0;i--)DATA.SaveObject(t,n[i])}).catch(function(){console.log("Failed to update local "+t+"objects")}).then(r)})},DeleteDatabase:function(){throw"Not implemented";},GetSetting:function(n,t){return new Promise(function(i){DATA.GetObject("settings",n).then(function(n){n==null||n.value==null?i(t):i(n.value)}).catch(function(){return t})})},SetSetting:function(n,t){return DATA.SaveObject("settings",{key:n,value:t})},AddObject:function(n,t){DATA.dbPromise.then(function(i){var r=i.transaction(n,"readwrite"),u=r.objectStore(n);return u.add(t),r.complete}).then(function(){debug&&console.log("Added object to the",n);debug&&console.dir(t)})},GetObject:function(n,t){return new Promise(function(i){DATA.dbPromise.then(function(r){var u=r.transaction(n,"readonly"),f=u.objectStore(n);f.get(t).then(function(n){i(n);debug&&console.log(n)})})})},DeleteObject:function(n,t){DATA.dbPromise.then(function(i){var r=i.transaction(n,"readwrite"),u=r.objectStore(n);return u.delete(t),r.complete}).then(function(){debug&&console.log(t,"was deleted from",n)})},SaveObject:function(n,t){DATA.dbPromise.then(function(i){var r=i.transaction(n,"readwrite"),u=r.objectStore(n);return u.put(t),r.complete}).then(function(){debug&&console.log("Object was updated in",n);debug&&console.dir(t)})},SearchObjects:function(n,t,i,r,u,f){var e=[];return new Promise(function(o){if(!DATA.DbOpenForCurrentUser()){o(e);return}DATA.dbPromise.then(function(u){var e=u.transaction(n,"readonly"),o=e.objectStore(n),s=o.index(t),f=null;return i&&r?f=IDBKeyRange.bound(i,r):i?f=IDBKeyRange.upperBound(r):r&&(f=IDBKeyRange.lowerBound(i)),s.openCursor(f)}).then(function s(n){if(n&&(!f||e.length!=f)){if(u){var t=u;return u=null,n.advance(t).then(s)}return debug&&console.log("Cursored at:",n.key),e.push(n.value),n.continue().then(s)}}).then(function(){return o(e)})})},GetObjects:function(n,t,i,r,u){return new Promise(function(f){if(!DATA.DbOpenForCurrentUser()){f({total:0,objects:null});return}DATA.dbPromise.then(function(t){var i=t.transaction(n,"readonly"),r=i.objectStore(n);return r.getAll()}).then(function(n){var e=null;r&&(n=n.filter(r));u&&(n=n.sort(u));t||(t=0);i&&(e=t+i);f({total:n.length,objects:e?n.slice(t,e):n.slice(t)})})})},get:function(n){return new Promise(function(t,i){var r=new XMLHttpRequest;r.open("GET",n);r.onload=function(){r.status==200?t(r.response):i(Error(r.statusText))};r.onerror=function(){i(Error("Network Error"))};r.send()})},getJson:function(n){return new Promise(function(t,i){DATA.get(n).then(JSON.parse).catch(function(){i()}).then(function(n){n&&n.loggedIn?t(n):i(n)})})},postJson:function(n,t){return new Promise(function(i,r){var u=new XMLHttpRequest;u.open("POST",n,!0);u.setRequestHeader("Content-Type","application/json");u.onload=function(){if(u.status==200)try{var n=JSON.parse(u.response);n&&n.loggedIn?i(n):r(n)}catch(t){i(u.response)}else r(Error(u.statusText))};u.onerror=function(){r(Error("Network Error"),n,t)};u.send(JSON.stringify(t))})}};DATA.Init().catch(function(n){debug&&console.log(n)});MESSAGING={alerts:0,subscribed:!1,subscription:null,syncProgressMessage:null,PromptForPush:function(){typeof DATA!="undefined"&&DATA.DbOpenForCurrentUser()&&typeof Notification!="undefined"&&(Notification.permission==="denied"?DATA.GetSetting("push-denied-alert-dismissed",0).then(function(n){(new Date).getTime()-n>6048e5&&MESSAGING.Alert("We can't let you know about your expiring vouchers and services because you blocked us :(","danger",null,function(){DATA.SetSetting("push-denied-alert-dismissed",(new Date).getTime())})}):Notification.permission!=="granted"&&MESSAGING.Alert('We\'ll need to let you know about your expiring vouchers and services. Please <a href="javascript:MESSAGING.SubscribeToPush();%close%">click here<\/a> to enable us to do that.'))},SubscribeToPush:function(){navigator.serviceWorker&&navigator.serviceWorker.ready.then(function(n){MESSAGING.RegisterPushSubscription(n)})},RegisterPushSubscription:function(n){return new Promise(function(t,i){n.pushManager.getSubscription().then(function(r){r?(MESSAGING.subscribed=!0,DATA.GetSetting("push-notified",!1).then(function(n){n||MESSAGING.PushNotify(r)}),debug&&console.log("Already subscribed to push notifications"),window.subscription=MESSAGING.subscription=r,t(r)):n.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:MESSAGING.urlB64ToUint8Array(publicKey)}).then(function(n){n&&(MESSAGING.subscribed=!0,debug&&console.log("Newly subscribed to push notifications"),window.subscription=MESSAGING.subscription=n,DATA.GetSetting("push-notified",!1).then(function(){MESSAGING.PushNotify(n)}),t(n));i()}).catch(function(){MESSAGING.get("/userapi/pushdenied")})})})},GetServerAlerts:function(){MESSAGING.get("/userapi/alerts").then(JSON.parse).then(function(n){n&&n.length>0&&n.forEach(function(n){MESSAGING.Alert(n.message,n.type,n.autoClose,n.onclose)})}).catch(function(n){debug&&console.log(n)})},ShowSyncProgress:function(n){if(0){n||(n="Caching your data");var t=document.querySelector("div.sync-progress");t||(t=document.createElement("div"),t.classList.add("sync-progress"),document.body.appendChild(t));t.innerHTML=n+' <img alt="" src="/content/sync-loading.gif" />';this.syncProgressMessage&&clearTimeout(this.syncProgressMessage);this.syncProgressMessage=setTimeout(function(){t.style.display="block"},1e3)}},HideSyncProgress:function(){!1&&(this.syncProgressMessage&&clearTimeout(this.syncProgressMessage),document.querySelector("div.sync-progress").style.display="none")},Alert:function(n,t,i,r){typeof t=="undefined"&&(t="warning");var u="#alert-"+MESSAGING.alerts+" button.close";n=n.replace("%close%","document.querySelector('"+u+"').click();");document.querySelector("div.alert-container").innerHTML+='<div id="alert-'+MESSAGING.alerts+'" class="alert alert-'+t+'"><button class="close" onclick="document.querySelector(\'#alert-'+MESSAGING.alerts+"').style.display = 'none';\">&times;<\/button>"+n+"<\/div>";i&&setTimeout(function(){document.querySelector(u).click()},i);typeof r=="function"&&document.querySelector(u).addEventListener("click",r);MESSAGING.alerts++},PushNotify:function(n){MESSAGING.postJson("/userapi/registerpush",n).then(function(){DATA.SetSetting("push-notified",!0)}).catch(function(n){n&&!n.loggedIn&&MESSAGING.Alert("We couldnt tell topup.co.zw that you want notifications, we'll try again just now though","warning",3e3)})},BrowserCheck:function(n){var t=MESSAGING.browserSpecs();n&&console.log("Browser: "+t.name+", Version: "+t.version)},GetPendable:function(n){MESSAGING.get(n).catch(function(){DATA.SaveObject("pending",{url:n})})},urlB64ToUint8Array:function(n){for(var u="=".repeat((4-n.length%4)%4),f=(n+u).replace(/\-/g,"+").replace(/_/g,"/"),i=window.atob(f),r=new Uint8Array(i.length),t=0;t<i.length;++t)r[t]=i.charCodeAt(t);return r},urlTokenEncode:function(n){var t=btoa(encodeURIComponent(n).replace(/%([0-9A-F]{2})/g,function(n,t){return String.fromCharCode("0x"+t)})),i=t.match(/=/g);return t.replace(/=/g,"")+(i==null?0:i.length)},browserSpecs:function(){var i=navigator.userAgent,t,n=i.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];return/trident/i.test(n[1])?(t=/\brv[ :]+(\d+)/g.exec(i)||[],{name:"IE",version:t[1]||""}):n[1]==="Chrome"&&(t=i.match(/\b(OPR|Edge)\/(\d+)/),t!=null)?{name:t[1].replace("OPR","Opera"),version:t[2]}:(n=n[2]?[n[1],n[2]]:[navigator.appName,navigator.appVersion,"-?"],(t=i.match(/version\/(\d+)/i))!=null&&n.splice(1,1,t[1]),{name:n[0],version:n[1]})},get:function(n){return new Promise(function(t,i){var r=new XMLHttpRequest;r.open("GET",n);r.onload=function(){r.status==200?t(r.response):i(Error(r.statusText))};r.onerror=function(n){debug&&console.log(n);i(Error("Network Error"))};r.send()})},postJson:function(n,t){return new Promise(function(i,r){var u=new XMLHttpRequest;u.open("POST",n,!0);u.setRequestHeader("Content-Type","application/json");u.onload=function(){if(u.status==200)try{var n=JSON.parse(u.response);n&&n.loggedIn?i(n):r(n)}catch(t){i(u.response)}else r(Error(u.statusText))};u.onerror=function(){debug&&console.log(e);r(Error("Network Error"),n,t)};u.send(JSON.stringify(t))})}};MESSAGING.PromptForPush();var VOUCHERS={perPage:10,page:1,pages:null,Init:function(){return VOUCHERS.SetupList(),new Promise(function(n,t){DATA.GetUserToken()?(VOUCHERS.AfterSync=function(){VOUCHERS.LoadList()},window.VouchersSyncd&&VOUCHERS.AfterSync(),n()):(MESSAGING.Alert('<a href="/user/login?returnurl='+MESSAGING.urlTokenEncode("/my/vouchers")+'">Sign in to topup.co.zw<\/a> to sync your vouchers',"warning"),VOUCHERS.LoadList(),t())})},AfterSync:null,GetVouchers:function(n,t,i){var r=null,u=null,e=null,f,o;if(typeof i!="undefined"&&i!==""&&(e=i==="true"),t!==""){f=new Date;f.setHours(0,0,0);switch(t){case"yesterday":r=new Date(f);r.setDate(f.getDate()-1);u=new Date(r);u.setHours(23,59,59);break;case"lastweek":o=f.getDay();r=new Date(f);r.setDate(f.getDate()-(6+o));u=new Date(r);u.setDate(r.getDate()+6);u.setHours(23,59,59);break;case"lastmonth":r=new Date(f);r.setMonth(f.getMonth()-1);r.setDate(1);u=new Date(r);u.setMonth(r.getMonth()+1);u.setSeconds(-1);break;case"thismonth":r=new Date(f);r.setDate(1);u=new Date;break;case"lastyear":r=new Date(f.getFullYear()-1,0,1,0,0,0);u=new Date(f.getFullYear()-1,11,31,23,59,59)}}return new Promise(function(t){typeof n!="undefined"&&(VOUCHERS.page=n==0?1:VOUCHERS.page+n);VOUCHERS.page<1&&(VOUCHERS.page=1);DATA.GetObjects("vouchers",(VOUCHERS.page-1)*VOUCHERS.perPage,VOUCHERS.perPage,function(n){return(e==null||(e?n.used!=null:n.used==null))&&(!u||n.purchased<=u)&&(!r||n.purchased>=r)},function(n,t){return t.purchased-n.purchased}).then(function(n){t(n)})})},ToggleUsed:function(n,t,i){DATA.GetObject("vouchers",parseInt(n)).then(function(n){n.used=i;DATA.SaveObject("vouchers",n)});MESSAGING.GetPendable("/userapi/voucherused/"+n+"?used="+i+"&guid="+t)},LoadList:function(n){var t=document.querySelector("#purchased").value,i=document.querySelector("#used").value;VOUCHERS.GetVouchers(n,t,i).then(function(n){VOUCHERS.RenderTable(n.objects,n.total)})},RenderTable:function(n,t){var i=$("#vouchers tbody");n&&n.length!=0?(i.html(""),$.each(n,function(){i.append(VOUCHERS.RenderLine(this))}),$(".pagination").show()):(i.html("<tr><td colspan='4'>(no vouchers)<\/td><\/tr>"),$(".pagination").hide());VOUCHERS.pages=Math.ceil(t/VOUCHERS.perPage);VOUCHERS.pages===0&&(VOUCHERS.page=0);document.querySelector(".pagination .description").innerHTML="Page "+VOUCHERS.page+" of "+VOUCHERS.pages;VOUCHERS.page>=VOUCHERS.pages?document.querySelector(".pagination .next").setAttribute("disabled","disabled"):document.querySelector(".pagination .next").removeAttribute("disabled");VOUCHERS.page<=1?document.querySelector(".pagination .prev").setAttribute("disabled","disabled"):document.querySelector(".pagination .prev").removeAttribute("disabled")},RenderLine:function(n){var t=new Date(n.purchased),i=t.getDate()+" "+["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][t.getMonth()]+" "+t.getFullYear()+" "+t.getHours()+":"+("0"+t.getMinutes()).slice(-2);return'<tr><td><div class="checkbox checkbox-primary"><input id="used-'+n.id+'" data-guid="'+n.guid+'" type="checkbox" '+(n.used?"checked='checked'":"")+' /><label for="used-'+n.id+'" style="padding:0" /><\/div><\/td><td>'+i+"<\/td><td>"+n.description+'<\/td><td><a class="showpin btn btn-primary btn-xs" data-id="'+n.id+'">View PIN<\/a> <a class="btn btn-default btn-xs" href="/transaction/summary/'+n.guid+'">Details<\/a><\/td><\/tr><tr id="voucher-'+n.id+'" style="display: none"><td class="title">PIN:<\/td><td colspan="3"><div class="pin" id="voucher-'+n.id+'-pin">'+n.pin+"<\/div><\/td><\/tr>"},SetupList:function(){$(document).on("click","input[id^=used-]",function(){var n=$(this);VOUCHERS.ToggleUsed(n.attr("id").substring(5),n.attr("data-guid"),n.is(":checked")?(new Date).getTime():null)});$(document).on("click",".showpin",function(){var t=$(this).attr("data-id"),n=$("#voucher-"+t);$("tr[id^=voucher-]").not(n).hide();n.toggle()})}},CONTACTS={perPage:10,page:1,pages:null,Init:function(){return new Promise(function(n,t){DATA.GetUserToken()?(CONTACTS.AfterSync=function(){CONTACTS.LoadList()},window.ContactsSyncd&&CONTACTS.AfterSync(),n()):(MESSAGING.Alert('<a href="/user/login?returnurl='+MESSAGING.urlTokenEncode("/my/accounts")+'">Sign in to topup.co.zw<\/a> to sync your contacts',"warning"),CONTACTS.LoadList(),t())})},AfterSync:null,Get:function(n,t){return t=t.toLowerCase(),new Promise(function(i){typeof n!="undefined"&&(CONTACTS.page=n==0?1:CONTACTS.page+n);CONTACTS.page<1&&(CONTACTS.page=1);DATA.GetObjects("contacts",(CONTACTS.page-1)*CONTACTS.perPage,CONTACTS.perPage,function(n){return!n.deleted&&(!t||n.name&&n.name.toLowerCase().indexOf(t)>-1||n.mobile&&n.mobile.toLowerCase().indexOf(t)>-1||n.email&&n.email.toLowerCase().indexOf(t)>-1)},function(n,t){return n.name<t.name?-1:n.name>t.name?1:0}).then(function(n){i(n)})})},GetFromCookie:function(){var n=[],t=Cookies.get("mobile"),i=Cookies.get("email");return t&&$.each(t.split("#"),function(){n.push({mobile:decodeURIComponent(this),name:decodeURIComponent(this)})}),i&&$.each(i.split("#"),function(){n.push({mobile:"",email:decodeURIComponent(this),name:decodeURIComponent(this)})}),n},Delete:function(n){confirm("Are you sure you want to delete this contact?")&&(DATA.GetObject("contacts",n).then(function(n){n.deleted=!0;n.updated=(new Date).getTime();DATA.SaveObject("contacts",n)}).then(CONTACTS.LoadList),MESSAGING.GetPendable("/userapi/deletecontact/"+n))},LoadList:function(n){CONTACTS.Get(n,document.querySelector("#search").value).then(function(n){CONTACTS.RenderTable(n.objects,n.total)})},RenderTable:function(n,t){var i=$("#list tbody");i.html("");n&&n.length!=0?(i.html(""),$.each(n,function(){i.append(CONTACTS.RenderLine(this))}),$(".pagination").show()):(i.html('<tr><td colspan="2">(no saved contacts)<\/td><td class="hidden-xs">&nbsp;<\/td><td class="hidden-xs hidden-sm">&nbsp;<\/td><\/tr>'),$(".pagination").hide());CONTACTS.pages=Math.ceil(t/CONTACTS.perPage);CONTACTS.pages===0&&(CONTACTS.page=0);document.querySelector(".pagination .description").innerHTML="Page "+CONTACTS.page+" of "+CONTACTS.pages;CONTACTS.page>=CONTACTS.pages?document.querySelector(".pagination .next").setAttribute("disabled","disabled"):document.querySelector(".pagination .next").removeAttribute("disabled");CONTACTS.page<=1?document.querySelector(".pagination .prev").setAttribute("disabled","disabled"):document.querySelector(".pagination .prev").removeAttribute("disabled")},RenderLine:function(n){return'<tr><td><div class="name">'+(n.name||"")+'<\/div><div class="mobile hidden-sm hidden-md hidden-lg">'+n.mobile+'<\/div><div class ="email hidden-md hidden-lg">'+(n.email||"")+'<\/div> <\/td><td class="hidden-xs">'+n.mobile+'<\/td><td class="hidden-xs hidden-sm">'+(n.email||"")+'<\/td> <td><a class="btn btn-default btn-xs" href="/my/viewcontact/'+n.guid+'">Change<\/a> <a class="btn btn-secondary btn-xs" href="javascript:CONTACTS.Delete(\''+n.guid+"')\">Delete<\/a><\/td><\/tr>"}},HISTORY={perPage:10,page:1,pages:null,Init:function(){return new Promise(function(n,t){DATA.GetUserToken()?(HISTORY.AfterSync=function(){HISTORY.LoadList()},window.HistorySyncd&&HISTORY.AfterSync(),n()):(MESSAGING.Alert('<a href="/user/login?returnurl='+MESSAGING.urlTokenEncode("/my/history")+'">Sign in to topup.co.zw<\/a> to sync your history',"warning"),HISTORY.LoadList(),t())})},AfterSync:null,Get:function(n,t,i){var r=null,u=null,f,e;if(i=i.toLowerCase(),t!==""){f=new Date;f.setHours(0,0,0);switch(t){case"yesterday":r=new Date(f);r.setDate(f.getDate()-1);u=new Date(r);u.setHours(23,59,59);break;case"lastweek":e=f.getDay();r=new Date(f);r.setDate(f.getDate()-(6+e));u=new Date(r);u.setDate(r.getDate()+6);u.setHours(23,59,59);break;case"lastmonth":r=new Date(f);r.setMonth(f.getMonth()-1);r.setDate(1);u=new Date(r);u.setMonth(r.getMonth()+1);u.setSeconds(-1);break;case"thismonth":r=new Date(f);r.setDate(1);u=new Date;break;case"lastyear":r=new Date(f.getFullYear()-1,0,1,0,0,0);u=new Date(f.getFullYear()-1,11,31,23,59,59)}}return new Promise(function(t){typeof n!="undefined"&&(HISTORY.page=n==0?1:HISTORY.page+n);HISTORY.page<1&&(HISTORY.page=1);DATA.GetObjects("history",(HISTORY.page-1)*HISTORY.perPage,HISTORY.perPage,function(n){return(!u||n.date<=u)&&(!r||n.date>=r)&&(!i||n.description.toLowerCase().indexOf(i)>-1)},function(n,t){return t.date-n.date}).then(function(n){t(n)})})},LoadList:function(n){HISTORY.Get(n,document.querySelector("#purchased").value,document.querySelector("#search").value).then(function(n){HISTORY.RenderTable(n.objects,n.total)})},RenderTable:function(n,t){var i=$("#list tbody");n&&n.length!=0?(i.html(""),$(".pagination").show(),$.each(n,function(){i.append(HISTORY.RenderLine(this))})):(i.html('<tr><td colspan="4">(no transaction history)<\/td><td colspan="2" class="hidden-xs">&nbsp;<\/td><\/tr>'),$(".pagination").hide());HISTORY.pages=Math.ceil(t/HISTORY.perPage);HISTORY.pages===0&&(HISTORY.page=0);document.querySelector(".pagination .description").innerHTML="Page "+HISTORY.page+" of "+HISTORY.pages;HISTORY.page>=HISTORY.pages?document.querySelector(".pagination .next").setAttribute("disabled","disabled"):document.querySelector(".pagination .next").removeAttribute("disabled");HISTORY.page<=1?document.querySelector(".pagination .prev").setAttribute("disabled","disabled"):document.querySelector(".pagination .prev").removeAttribute("disabled")},RenderLine:function(n){var r=new Date(n.date),u=r.getDate()+" "+["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][r.getMonth()]+" "+r.getFullYear()+' <span class="hidden-xs">'+r.getHours()+":"+("0"+r.getMinutes()).slice(-2)+"<\/span>",t="",i="";switch(n.statusId){case 0:t='<span class="label label-primary">ABANDONED<\/span>';i='<span class="hidden-sm hidden-md hidden-lg label label-primary" style="margin-right: 5px;">ABANDONED<\/span>';break;case 1:t='<span class="label label-warning">AWAITING PAYMENT<\/span>';i='<span class="hidden-sm hidden-md hidden-lg label label-warning" style="margin-right: 5px;">AWAITING PAYMENT<\/span>';break;case 2:t='<span class="label label-info">PAID<\/span>';i='<span class="hidden-sm hidden-md hidden-lg label label-info" style="margin-right: 5px;">PAID<\/span>';break;case 3:t='<span class="label label-warning">PENDING REFUND<\/span>';i='<span class="hidden-sm hidden-md hidden-lg label label-warning" style="margin-right: 5px;">PENDING REFUND<\/span>';break;case 4:t='<span class="label label-default">REFUNDED<\/span>';i='<span class="hidden-sm hidden-md hidden-lg label label-default" style="margin-right: 5px;">REFUNDED<\/span>';break;case 5:t='<span class="label label-danger">FAILED<\/span>';i='<span class="hidden-sm hidden-md hidden-lg label label-danger" style="margin-right: 5px;">FAILED<\/span>';break;case 6:t='<span class="label label-success">COMPLETE<\/span>';i='<span class="hidden-sm hidden-md hidden-lg label label-success" style="margin-right: 5px;">COMPLETE<\/span>';break;case 8:t='<span class="label label-default">CANCELLED<\/span>';i='<span class="hidden-sm hidden-md hidden-lg label label-default" style="margin-right: 5px;">CANCELLED<\/span>'}return"<tr><td>"+u+"<\/td><td><strong>"+n.description+"<\/strong><\/td><td>"+(n.currency?n.currency:"ZWL")+n.amount+'<\/td><td class="hidden-xs">'+n.reference+'<\/td><td><a class="btn btn-primary btn-xs" href="/transaction/repeattransaction/'+n.guid+'">Repeat<\/a> <a class="btn btn-default btn-xs" href="/transaction/summary/'+n.guid+'">Details<\/a><\/td><\/tr>'}},ACCOUNTS={perPage:10,page:1,pages:null,Init:function(){return new Promise(function(n,t){ACCOUNTS.SetupList();DATA.GetUserToken()?(ACCOUNTS.AfterSync=function(){ACCOUNTS.LoadList()},window.AccountsSyncd&&ACCOUNTS.AfterSync(),n()):(MESSAGING.Alert('<a href="/user/login?returnurl='+MESSAGING.urlTokenEncode("/my/accounts")+'">Sign in to topup.co.zw<\/a> to sync your accounts',"warning"),ACCOUNTS.LoadList(),t())})},AfterSync:null,Get:function(n,t){return t=t.toLowerCase(),new Promise(function(i){typeof n!="undefined"&&(ACCOUNTS.page=n==0?1:ACCOUNTS.page+n);ACCOUNTS.page<1&&(ACCOUNTS.page=1);DATA.GetObjects("accounts",(ACCOUNTS.page-1)*ACCOUNTS.perPage,ACCOUNTS.perPage,function(n){return!n.deleted&&(!t||n.name&&n.name.toLowerCase().indexOf(t)>-1||n.type&&n.type.toLowerCase().indexOf(t)>-1||n.accountNumber&&n.accountNumber.toLowerCase().indexOf(t)>-1||n.smsConfirmation&&n.smsConfirmation.toLowerCase().indexOf(t)>-1)},function(n,t){return n.type<t.type?-1:n.type>t.type?1:n.name<t.name?-1:n.name>t.name?1:0}).then(function(n){i(n)})})},GetFromCookie:function(){var n=[],r=Cookies.get(),t,i;for(t in r)i=t.match(/^zssbpp-account(-\w+){1,2}$/),i&&$.each(r[t].split("#"),function(){if(this.length>0){var t=this.split(":");n.push({type:"zssbillpayment",typeId:1,subtype:i[1].substring(1),name:t.length==1?"":t[1],accountNumber:t[0]})}});return $.each(Cookies.get("total_cardnumber").split("#"),function(){this.length>0&&n.push({type:"totalfuelcard",typeId:2,name:"",accountNumber:this})}),$.each(Cookies.get("telone_phone_number").split("#"),function(){if(this.length>0){var t=this.split(":");n.push({type:"telone",typeId:3,name:t.length==1?"":decodeURIComponent(t[1]),accountNumber:decodeURIComponent(t[0])})}}),$.each(n,function(){this.name=decodeURI(this.name);this.accountNumber=decodeURI(this.accountNumber)}),n},Delete:function(n){confirm("Are you sure you want to delete this account?")&&(DATA.GetObject("accounts",n).then(function(n){n.deleted=!0;n.updated=(new Date).getTime();DATA.SaveObject("accounts",n)}).then(ACCOUNTS.LoadList),MESSAGING.GetPendable("/userapi/deleteaccount/"+n))},LoadList:function(n){ACCOUNTS.Get(n,document.querySelector("#search").value).then(function(n){ACCOUNTS.RenderTable(n.objects,n.total)})},RenderTable:function(n,t){var i=$("#list tbody");n&&n.length!=0?(i.html(""),$.each(n,function(){i.append(ACCOUNTS.RenderLine(this))}),$(".pagination").show()):(i.html('<td colspan="2">(no stored accounts)<\/td><td class="hidden-xs">&nbsp;<\/td><td class="hidden-xs hidden-sm hidden-md">&nbsp;<\/td>'),$(".pagination").hide());ACCOUNTS.pages=Math.ceil(t/ACCOUNTS.perPage);ACCOUNTS.pages===0&&(ACCOUNTS.page=0);document.querySelector(".pagination .description").innerHTML="Page "+ACCOUNTS.page+" of "+ACCOUNTS.pages;ACCOUNTS.page>=ACCOUNTS.pages?document.querySelector(".pagination .next").setAttribute("disabled","disabled"):document.querySelector(".pagination .next").removeAttribute("disabled");ACCOUNTS.page<=1?document.querySelector(".pagination .prev").setAttribute("disabled","disabled"):document.querySelector(".pagination .prev").removeAttribute("disabled")},RenderLine:function(n){return'<tr><td class="hidden-xs">'+n.type+'<\/td><td class="showaccount" data-id="'+n.guid+'"><div class="type hidden-sm hidden-md hidden-lg">'+n.type+'<\/div><div class="name">'+n.name+'<\/div><\/td><td class="hidden-xs hidden-sm hidden-md">'+n.accountNumber+'<\/td><td><a class="btn btn-primary btn-xs" href="/my/payaccount/'+n.guid+'">Make Payment<\/a><a class="btn btn-tertiary btn-xs" href="/my/viewaccount/'+n.guid+'">Change<\/a><a class="btn btn-secondary btn-xs" href="javascript:ACCOUNTS.Delete(\''+n.guid+'\')">Delete<\/a><\/td><\/tr><tr id="account-'+n.guid+'" style="display:none"><td colspan="2"><div class="account">Account: '+n.accountNumber+"<\/div>"+(n.smsConfirmation?'<div class="sms">SMS Confirmation: '+n.smsConfirmation+"<\/div>":"")+"<\/td><\/tr>"},SetupList:function(){$(document).on("click",".showaccount",function(){var t=$(this).attr("data-id"),n=$("#account-"+t);$("tr[id^=account-]").not(n).hide();n.toggle()})}},PAYMETHODS={perPage:10,page:1,pages:null,Init:function(){return new Promise(function(n,t){DATA.GetUserToken()?(PAYMETHODS.AfterSync=function(){PAYMETHODS.LoadList()},window.PaymethodsSyncd&&PAYMETHODS.AfterSync(),n()):(MESSAGING.Alert('<a href="/user/login?returnurl='+MESSAGING.urlTokenEncode("/my/paymentmethods")+'">Sign in to topup.co.zw<\/a> to sync your payment methods',"warning"),PAYMETHODS.LoadList(),t())})},AfterSync:null,Get:function(n){return new Promise(function(t){typeof n!="undefined"&&(PAYMETHODS.page=n==0?1:PAYMETHODS.page+n);PAYMETHODS.page<1&&(PAYMETHODS.page=1);DATA.GetObjects("paymentmethods",(PAYMETHODS.page-1)*PAYMETHODS.perPage,PAYMETHODS.perPage,function(n){return!n.deleted},function(n,t){return n.name<t.name?-1:n.name>t.name?1:0}).then(function(n){t(n)})})},GetFromCookie:function(n){var t=[],i=Cookies.get("paymentmethod");return i&&$.each(i.split("#"),function(){var i=this.split(":");i.length!=2||n&&i[1]!=n||t.push({account:decodeURIComponent(i[0]),type:i[1]==2?"Mobile Money Wallet":"Other Payment Method",typeId:i[1]})}),t},Delete:function(n){confirm("Are you sure you want to delete this payment method?")&&(DATA.GetObject("paymentmethods",n).then(function(n){n.deleted=!0;n.updated=(new Date).getTime();DATA.SaveObject("paymentmethods",n)}).then(PAYMETHODS.LoadList),MESSAGING.GetPendable("/userapi/deletepaymentmethod/"+n))},LoadList:function(n){PAYMETHODS.Get(n).then(function(n){PAYMETHODS.RenderTable(n.objects,n.total)})},RenderTable:function(n,t){var i=$("#list tbody");n&&n.length!=0?(i.html(""),$.each(n,function(){i.append(PAYMETHODS.RenderLine(this))}),$(".pagination").show()):(i.html("<tr><td colspan='3'>(no payment methods)<\/td><\/tr>"),$(".pagination").hide());PAYMETHODS.pages=Math.ceil(t/PAYMETHODS.perPage);PAYMETHODS.pages===0&&(PAYMETHODS.page=0);document.querySelector(".pagination .description").innerHTML="Page "+PAYMETHODS.page+" of "+PAYMETHODS.pages;PAYMETHODS.page>=PAYMETHODS.pages?document.querySelector(".pagination .next").setAttribute("disabled","disabled"):document.querySelector(".pagination .next").removeAttribute("disabled");PAYMETHODS.page<=1?document.querySelector(".pagination .prev").setAttribute("disabled","disabled"):document.querySelector(".pagination .prev").removeAttribute("disabled")},RenderLine:function(n){return"<tr><td>"+n.type+"<\/td><td>"+n.account+'<\/td><td><a class="btn btn-secondary btn-xs" href="javascript:PAYMETHODS.Delete(\''+n.guid+"')\">Delete<\/a><\/td><\/tr>"}}